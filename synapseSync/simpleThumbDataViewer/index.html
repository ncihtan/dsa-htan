<!DOCTYPE HTML>
<html>

<head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="//cdn.webix.com/edge/webix.css" type="text/css">
    <script src="//cdn.webix.com/edge/webix.js" type="text/javascript"></script>
    <style>
        .webix_axis_item_x {
            padding-top: 5px;
            padding-left: 10px;
            transform: rotate(90deg);
        }
    </style>
</head>

<body>
    <script type="text/javascript" charset="utf-8">
        /* app code */

        const serverApiURL = "https://imaging.htan.dev/girder/api/v1/"

        var histChart = {
            id: "histChart",
            //            height: 400,
            body: {
                view: "form",
                id: 'histForm',
                elements: [{
                        localId: 'histogramChart',
                        id: 'histogramChart',
                        view: "chart",
                        height: 360,
                        width: 530,
                        type: "splineArea",
                        scale: "logarithmic",
                        yValue: "#yValue#",
                        color: "#36abee",
                        dynamic: false,
                        yAxis: {
                            template: yValue => (yValue % 50 ? "" : `<span title='${yValue}' class='y-axis-number-item ellipsis-text'>${yValue}</span>`)
                        },
                        xAxis: {
                            start: 0,
                            end: 255,
                            step: 50,
                            template: ({
                                xValue
                            }) => (xValue % 50 ? "" : `<span title='${xValue}'>${xValue}</span>`)
                        }
                    }, {
                        margin: 5,
                        cols: [{
                            name: "min",
                            view: "text",
                            label: "min"
                        }, {
                            name: "max",
                            view: "text",
                            label: "max"
                        }]
                    }, {
                        margin: 5,
                        cols: [{
                            name: "range",
                            view: "text",
                            label: "range"
                        }, {
                            name: "samples",
                            view: "text",
                            label: "samples"
                        }]
                    }

                ]
            }
        }

        // this._colorPicker,
        // this._rangeSlider,
        // {
        //         cols: [
        //                 {
        //                         view: "button",
        //                         css: "btn-contour",
        //                         label: "Cancel",
        //                         click: () => {
        //                                 this.getForm().setValues(this._initValues);
        //                                 this.applyChanges();
        //                                 this.closeWindow();
        //                         }
        //                 },
        //                 {},





        // $roots keeps previous parent properties as they will be added as a prefix for each prop.
        // $sep is just a preference if you want to seperate nested paths other than dot.
        const flatten = (obj, roots = [], sep = '.') => Object
            // find props of given object
            .keys(obj)
            // return an object by iterating props
            .reduce((memo, prop) => Object.assign(
                // create a new object
                {},
                // include previously returned object
                memo,
                Object.prototype.toString.call(obj[prop]) === '[object Object]'
                // keep working if value is an object
                ?
                flatten(obj[prop], roots.concat([prop]))
                // include current prop and value and prefix prop with the roots
                :
                {
                    [roots.concat([prop]).join(sep)]: obj[prop]
                }
            ), {})

        webix.ready(function() {

            $.getJSON("./mvpImageData.working.json").then(d => {

                d.forEach(element => {
                    $$("imageDataTable").parse(flatten(element))
                });

                console.log(d)
                $$("rawImageList").parse(d)
                    // $$("imageDataTable").parse(d)
                $$("imageDataView").parse(d)




            })
        })


        webix.ui({
            "cols": [{
                "width": 200,
                "rows": [{
                    "padding": {
                        "left": 10
                    },
                    "cols": [{
                        "view": "label",
                        "label": "Images"
                    }, {
                        "view": "icon",
                        "icon": "wxi-search"
                    }]
                }, {
                    "view": "list",
                    id: "rawImageList",
                    template: "#name#",
                    on: {
                        onItemClick: function(ev, id) {
                            console.log(id)


                        }
                    }
                }]
            }, {
                "rows": [{
                    view: "dataview",
                    id: "imageDataView",
                    gravity: 2,
                    type: {
                        width: 260,
                        height: 260

                    },
                    select: true,
                    navigation: true,
                    on: {
                        onAfterSelect: function(ev, id) {
                            var item = this.getSelectedItem();
                            $.getJSON(serverApiURL + "item/" + item._id + "/tiles/histogram").then(d => {
                                console.log(d)
                                    //data is in d[0]
                                    //d.range min max samples
                                    //replacing this to use the bin_edges.. I think it makes more sense
                                const histogram = d[0];
                                const chartValues = histogram.hist.map((value, i) => ({
                                    xValue: histogram.bin_edges[i],
                                    yValue: value
                                }));
                                $$('histogramChart').clearAll();
                                $$('histogramChart').parse(chartValues);


                                $$('histForm').setValues(histogram)
                            })

                        }
                    },

                    template: "<img src=https://imaging.htan.dev/girder/api/v1/item/#_id#/tiles/thumbnail?frame=0&style=" +
                        encodeURIComponent(JSON.stringify({
                            bands: [{
                                palette: ['#000000', '#0000ff'],
                                max: "auto"
                            }, {
                                frame: 1,
                                palette: ['#000000', '#00ff00'],
                                max: "auto"
                            }, {
                                frame: 2,
                                palette: ['#000000', '#ff0000'],
                                max: "auto"
                            }]
                        })) + " ></img>"
                }, {
                    "cols": [{
                            "view": "datatable",
                            autoConfig: true,
                            id: "imageDataTable"
                        },

                        // {
                        //     "view": "chart",
                        //     "type": "barH",
                        //     id: "histogram",
                        //     "yAxis": {
                        //         "template": "#value#"
                        //     },
                        //     "xAxis": {},
                        //     "color": "#color#",
                        //     "url": ""
                        // },
                        histChart
                    ]
                }]
            }]
        })
    </script>
</body>

</html>
<!-- 
// { "view": "chart", "type": "spline", "xAxis": { "template": "#value#", "lines": false },
// 	"yAxis": {},
// 	"url": ""
// },
// {
// 	"cols": [
// 		{ "view": "chart", "width": 400, "pieInnerText": "#value#", "label": "#month#", "url": "" },
// 		{ "view": "geochart", "url": "" }
// 	]
     // 	params.layer.url = metadataUrl + '/zxy/{z}/{x}/{y}?frame=0&style=' + 
        // encodeURIComponent(JSON.stringify({
        //   bands: [{
        //     palette: ['#000000', '#0000ff'],
        //     max: 30005
        //   }, {
        //     frame: 20,
        //     palette: ['#000000', '#00ff00'],
        //     max: 30005
        //   }, {
        //     frame: 28,
        //     palette: ['#000000', '#ff0000'],
        //     max: 10005
        //   }]
        // }));
// }, -->